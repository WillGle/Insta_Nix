#!/usr/bin/env bash
# Post-Reboot Verification Script for Ryzen Optimization

echo "----------------------------------------------------------------"
echo "üîç System Optimization Verification"
echo "----------------------------------------------------------------"

# 1. Check Kernel Version
UNAME=$(uname -r)
echo "üêß Kernel Version: $UNAME"
if [[ "$UNAME" == *"zen"* ]]; then
    echo "‚úÖ Zen Kernel Active"
else
    echo "‚ö†Ô∏è Warning: Zen Kernel NOT Active"
fi


# 2. Check Ryzen SMU Module
if lsmod | grep -q "ryzen_smu"; then
    echo "‚úÖ ryzen_smu Module Loaded"
else
    echo "‚ùå ryzen_smu Module Failed to Load!"
    echo "   (This prevents Undervolting/Curve Optimizer)"
fi

# 3. Check RyzenAdj Status
echo "----------------------------------------------------------------"
echo "‚ö° RyzenAdj Metrics (Current):"
sudo ryzenadj -i | grep -E "stapm_limit|fast_limit|slow_limit|tctl_temp|Curve Optimizer"
echo "----------------------------------------------------------------"

# 4. Stress Test Option
read -p "üöÄ Do you want to run a 30-second Stress Test? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üî• Running Stress Test (CPU)... Monitor temps in btop!"
    echo "   (Open a new terminal and run 'btop' now if you want to watch)"
    sleep 2
    stress-ng --cpu 16 --timeout 30s --metrics-brief
    echo "‚úÖ Stress Test Complete."
else
    echo "‚ÑπÔ∏è  Skipping stress test."
fi

echo "----------------------------------------------------------------"
echo "To toggle power modes, run: /etc/nixos/dotfiles/local-bin/waybar-power-monitor toggle"
