#!/usr/bin/env bash
set -euo pipefail
export LC_ALL=C
# Waybar consolidated hardware monitor
# Usage: waybar-power-monitor apu|sys|pwr|prof|toggle

MODE="${1:-pwr}"

BAT_POWER="/sys/class/power_supply/BAT1/power_now"
BAT_VOLT="/sys/class/power_supply/BAT1/voltage_now"
BAT_CAP="/sys/class/power_supply/BAT1/capacity"
BAT_STATUS="/sys/class/power_supply/BAT1/status"
BAT_ENERGY_NOW="/sys/class/power_supply/BAT1/energy_now"
BAT_ENERGY_FULL="/sys/class/power_supply/BAT1/energy_full"
BAT_ENERGY_FULL_DESIGN="/sys/class/power_supply/BAT1/energy_full_design"
BAT_CYCLE_COUNT="/sys/class/power_supply/BAT1/cycle_count"

# --- Icons (Nerd Font Hex) ---
ICON_CPU=$(printf "\uf2db")
ICON_GPU=$(printf "\uf108")
ICON_BAT_100=$(printf "\uf240")
ICON_BAT_80=$(printf "\uf241")
ICON_BAT_60=$(printf "\uf242")
ICON_BAT_40=$(printf "\uf243")
ICON_BAT_20=$(printf "\uf244")
ICON_PLUG=$(printf "\uf1e6")
ICON_WATT=$(printf "\uf0e7")
ICON_PERF=$(printf "\uf0e7")     # Bolt
ICON_BALANCED=$(printf "\uf24e") # Scales
ICON_SAVER=$(printf "\uf06c")   # Leaf

# --- Helper Functions ---

apply_ryzen_settings() {
    local prof="$1"
    # Optimized for Ryzen 7 8845H (Hawk Point)
    case "$prof" in
        performance)
            # High Perf: 54W limit (Max cTDP), -20 All Core CO
            # EPP: performance (bias towards high clocks)
            sudo /run/current-system/sw/bin/ryzenadj --stapm-limit=54000 --fast-limit=54000 --slow-limit=54000 --tctl-temp=95 --vrm-current=70000 --vrmmax-current=90000 --set-coall=-20 2>/dev/null || true
            ;;
        balanced)
            # Balanced: 28W limit, -15 All Core CO
            # EPP: balance_performance (responsive but efficient)
            sudo /run/current-system/sw/bin/ryzenadj --stapm-limit=28000 --fast-limit=28000 --slow-limit=28000 --tctl-temp=85 --set-coall=-15 2>/dev/null || true
            ;;
        power-saver)
            # Saver: 15W limit, -20 All Core CO
            # EPP: power (bias towards low clocks/idle)
            sudo /run/current-system/sw/bin/ryzenadj --stapm-limit=15000 --fast-limit=15000 --slow-limit=15000 --tctl-temp=75 --set-coall=-20 2>/dev/null || true
            ;;
    esac
}

get_temp() {
    local name="$1"
    for d in /sys/class/hwmon/hwmon*; do
        if [ "$(cat "$d/name" 2>/dev/null)" = "$name" ]; then
            # Try multiple common temperature inputs (Edge/Junction usually safer/faster)
            cat "$d/edge_input" 2>/dev/null || \
            cat "$d/temp1_input" 2>/dev/null || \
            cat "$d/junction_input" 2>/dev/null || \
            echo 0
            return
        fi
    done
    echo 0
}

get_cpu_usage() {
    # Calculate CPU usage over a short interval (0.1s)
    # Read 1
    read -r cpu a b c d e f g _ < /proc/stat
    prev_idle=$e
    prev_total=$((a+b+c+d+e+f+g))
    sleep 0.1
    # Read 2
    read -r cpu a b c d e f g _ < /proc/stat
    idle=$e
    total=$((a+b+c+d+e+f+g))
    
    diff_idle=$((idle - prev_idle))
    diff_total=$((total - prev_total))
    
    if [ "$diff_total" -eq 0 ]; then echo 0; else
        echo $((100 * (diff_total - diff_idle) / diff_total))
    fi
}

get_gpu_usage() {
    cat /sys/class/drm/card0/device/gpu_busy_percent 2>/dev/null || echo 0
}

get_cpu_freq() {
    # Average current frequency of all cores in GHz
    awk '{sum+=$1} END {printf "%.1f", sum/NR/1000000}' /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq
}

get_gpu_freq() {
    # GPU Shader Clock in MHz
    awk '{printf "%d", $1/1000000}' /sys/class/hwmon/hwmon0/freq1_input 2>/dev/null || echo 0
}

# --- Main Data Gathering ---

# System Total Power & Voltage
sys_uw=$(cat "$BAT_POWER" 2>/dev/null || echo 0)
sys_w=$(awk -v uw="${sys_uw:-0}" "BEGIN{printf \"%.1f\", uw/1000000}")
volt_uv=$(cat "$BAT_VOLT" 2>/dev/null || echo 0)
volt_v=$(awk -v uv="${volt_uv:-0}" "BEGIN{printf \"%.2f\", uv/1000000}")
cap=$(cat "$BAT_CAP" 2>/dev/null || echo 0)
stat=$(cat "$BAT_STATUS" 2>/dev/null || echo "Unknown")

# Battery Time Estimation
time_str=""
if [ "${sys_uw:-0}" -gt 500000 ]; then # 0.5W minimum to avoid noise
    e_now=$(cat "$BAT_ENERGY_NOW" 2>/dev/null || echo 0)
    e_full=$(cat "$BAT_ENERGY_FULL" 2>/dev/null || echo 0)
    
    if [ "$stat" = "Discharging" ]; then
        # Hours remaining
        hours_raw=$(awk -v now="${e_now:-0}" -v uw="${sys_uw:-1}" "BEGIN{print now / uw}")
    elif [ "$stat" = "Charging" ]; then
        # Hours until full
        hours_raw=$(awk -v full="${e_full:-0}" -v now="${e_now:-0}" -v uw="${sys_uw:-1}" "BEGIN{print (full - now) / uw}")
    fi
    
    if [ -n "$hours_raw" ]; then
        h_m=$(awk -v hr="$hours_raw" 'BEGIN{ 
            if (hr > 0 && hr < 24) {
                h = int(hr);
                m = int((hr - h) * 60 + 0.5);
                if (m == 60) { h++; m = 0; }
                printf "%d:%02d", h, m;
            }
        }')
        [ -n "$h_m" ] && time_str="[$h_m]"
    fi
fi

# Battery Health & Capacity Metrics
e_now=$(cat "$BAT_ENERGY_NOW" 2>/dev/null || echo 0)
e_full=$(cat "$BAT_ENERGY_FULL" 2>/dev/null || echo 0)
e_design=$(cat "$BAT_ENERGY_FULL_DESIGN" 2>/dev/null || echo 0)
cycles=$(cat "$BAT_CYCLE_COUNT" 2>/dev/null || echo 0)

wh_now=$(awk -v en="${e_now:-0}" "BEGIN{printf \"%.1f\", en/1000000}")
wh_full=$(awk -v ef="${e_full:-0}" "BEGIN{printf \"%.1f\", ef/1000000}")
health=$(awk -v ef="${e_full:-0}" -v ed="${e_design:-1}" "BEGIN{printf \"%.1f\", (ef/ed)*100}")

# GPU Power & Temp
gpu_w=0
gpu_temp_raw=$(get_temp "amdgpu")
for d in /sys/class/hwmon/hwmon*; do
    if [ "$(cat "$d/name" 2>/dev/null)" = "amdgpu" ]; then
        # Try instantaneous input first (less likely to block), then average
        gpu_uw=$(cat "$d/power1_input" 2>/dev/null || cat "$d/power1_average" 2>/dev/null || echo 0)
        gpu_w=$(awk -v uw="${gpu_uw:-0}" "BEGIN{printf \"%.1f\", uw/1000000}")
        break
    fi
done

cpu_temp_raw=$(get_temp "k10temp")
cpu_w=$(awk -v sw="${sys_w:-0}" -v gw="${gpu_w:-0}" -v stat="$stat" 'BEGIN{
    if(stat == "Charging" || stat == "Full") {
        print "5.0";
    } else {
        v=sw-gw; if(v<0) v=0; printf "%.1f", v;
    }
}')

# Battery Icon & Style Class
icon="$ICON_BAT_100"
if [ "${cap:-0}" -le 20 ]; then icon="$ICON_BAT_20"; fi
if [ "${cap:-0}" -gt 20 ] && [ "${cap:-0}" -le 40 ]; then icon="$ICON_BAT_40"; fi
if [ "${cap:-0}" -gt 40 ] && [ "${cap:-0}" -le 60 ]; then icon="$ICON_BAT_60"; fi
if [ "${cap:-0}" -gt 60 ] && [ "${cap:-0}" -le 80 ]; then icon="$ICON_BAT_80"; fi
if [ "$stat" = "Charging" ]; then icon="$ICON_PLUG"; fi

b_cls="normal"
if [ "${cap:-0}" -le 20 ]; then b_cls="critical"; fi
if [ "$stat" = "Charging" ]; then b_cls="charging"; fi

# --- Output Generation ---

case "$MODE" in
    apu) # Formerly GPU
        # APU Metrics: Power (Pkg), Temp (CPU & GPU), Usage, Freq
        t_gpu_raw=$(get_temp "amdgpu")
        t_cpu_raw=$(get_temp "k10temp")
        
        t_gpu=$(awk -v tr="${t_gpu_raw:-0}" "BEGIN{printf \"%.0f\", tr/1000}")
        t_cpu=$(awk -v tr="${t_cpu_raw:-0}" "BEGIN{printf \"%.0f\", tr/1000}")
        
        # Usage & Freq
        # Note: calling usage functions first as they might sleep
        cpu_util=$(get_cpu_usage)
        gpu_util=$(get_gpu_usage)
        cpu_freq=$(get_cpu_freq)
        gpu_freq=$(get_gpu_freq)

        # Classes
        t_cls="normal"
        if [ "$t_cpu" -ge 85 ] || [ "$t_gpu" -ge 85 ]; then t_cls="critical";
        elif [ "$t_cpu" -ge 70 ] || [ "$t_gpu" -ge 70 ]; then t_cls="hot";
        fi
        
        # Format: [Chip] [CPUÂ°] [GPU_Icon] [GPUÂ°] [APU W]
        # Tooltip: Usage, Freq, Detailed Power
        # Format: [Chip Icon] [CPUÂ°] [GPU Icon] [GPUÂ°] [CPU Freq] [APU W]
        # Tooltip: Usage, Freq, Detailed Power
        printf '{"text":"ï’¼ %sÂ°C %s %sÂ°C %sGHz %sW", "tooltip":"<b>APU (Ryzen 7 8845H)</b>\\n----------------\\n<b>CPU:</b> %s%% @ %sGHz\\n<b>GPU:</b> %s%% @ %sMHz\\n\\n<b>Thermals:</b>\\nCPU Core: %sÂ°C\\niGPU:     %sÂ°C\\n\\n<b>Power (Package):</b> %sW", "class":["%s", "normal"]}\n' \
            "$t_cpu" "$ICON_GPU" "$t_gpu" "$cpu_freq" "$gpu_w" \
            "$cpu_util" "$cpu_freq" \
            "$gpu_util" "$gpu_freq" \
            "$t_cpu" "$t_gpu" \
            "$gpu_w" \
            "$t_cls"
        ;;
    sys) # Formerly CPU
        # System Metrics: Screen/Board Power
        # Calculated as: Total - APU
        
        p_cls="normal"
        if [ "$(awk -v w="${cpu_w:-0}" 'BEGIN{if(w>15) print 1; else print 0}')" -eq 1 ]; then p_cls="high"; fi

        printf '{"text":"ï„‰ âš¡%sW", "tooltip":"<b>System / Screen</b>\\n----------------\\nDisplay, WiFi, SSD, Mobo\\n\\n<b>Power Consumption:</b> %sW", "class":["%s", "normal"]}\n' \
            "$cpu_w" "$cpu_w" "$p_cls"
        ;;
    pwr)
        # Power Profile info (for tooltip only)
        profile=$(/run/current-system/sw/bin/powerprofilesctl get 2>/dev/null || echo "unknown")

        # Determine Intake vs Consumption vs Battery Flow
        if [ "$stat" = "Discharging" ]; then
            w_in="0.0"
            w_out="$sys_w"
            w_batt=$(awk -v sw="${sys_w:-0}" "BEGIN{printf \"-%.1f\", sw}")
        else
            w_out=$(awk -v gw="${gpu_w:-0}" "BEGIN{printf \"%.1f\", gw + 5.0}") 
            if [ "$stat" = "Charging" ]; then
                w_in=$(awk -v out="${w_out:-0}" -v sw="${sys_w:-0}" "BEGIN{printf \"%.1f\", out + sw}")
                w_batt=$(awk -v sw="${sys_w:-0}" "BEGIN{printf \"+%.1f\", sw}")
            elif [ "$stat" = "Full" ]; then
                 w_in="$w_out"
                 w_batt="0.0"
                 # Ensure we show 100% properly
                 cap="100"
            else
                w_in="$w_out"
                w_batt="0.0"
            fi
        fi

        w_cls=$(awk -v win="${w_in:-0}" "BEGIN{if(win>=80) print \"high\"; else if(win>=40) print \"medium\"; else print \"normal\"}")
        
        # Power Flow display: â†“[In]W  â†‘[Out]W  [BatIcon] [Cap]%
        printf '{"text":"â†“%sW  â†‘%sW  %s  %s%%", "tooltip":"âš¡ System Energy Flow\\n---------------------------\\nIntake (Wall):   %sW\\nConsumption:     %sW\\n  â””â”€ APU (Pkg):     %sW\\n\\nðŸ”‹ Battery Status\\n---------------------------\\nBattery:        %s%% (%s)\\nHealth:         %s%%\\nCycles:         %s\\nCapacity:      %s / %s Wh\\nVoltage:        %sV\\nRemaining:      %s\\nProfile:        %s", "class":["%s", "%s", "power-flow"]}\n' \
            "$w_in" "$w_out" "$icon" "$cap" \
            "$w_in" "$w_out" "$gpu_w" \
            "$cap" "$stat" "$health" "$cycles" "$wh_now" "$wh_full" "$volt_v" "${time_str:-N/A}" "$profile" \
            "$w_cls" "$b_cls"
        ;;
    prof)
        profile=$(/run/current-system/sw/bin/powerprofilesctl get 2>/dev/null || echo "unknown")
        case "$profile" in
            performance)  p_icon="$ICON_PERF"; p_cls="perf" ;;
            balanced)     p_icon="$ICON_BALANCED"; p_cls="normal" ;;
            power-saver)  p_icon="$ICON_SAVER"; p_cls="saver" ;;
            *)            p_icon="?"; p_cls="normal" ;;
        esac
        printf '{"text":" %s ", "tooltip":"Power Profile: %s\\nClick to cycle", "class":"%s"}\n' "$p_icon" "$profile" "$p_cls"
        ;;
    toggle)
        p=$(/run/current-system/sw/bin/powerprofilesctl get)
        case "$p" in
            performance) 
                /run/current-system/sw/bin/powerprofilesctl set balanced 
                apply_ryzen_settings "balanced"
                ;;
            balanced)    
                /run/current-system/sw/bin/powerprofilesctl set power-saver
                apply_ryzen_settings "power-saver"
                ;;
            power-saver) 
                /run/current-system/sw/bin/powerprofilesctl set performance 
                apply_ryzen_settings "performance"
                ;;
        esac
        pkill -RTMIN+2 waybar
        ;;
esac
