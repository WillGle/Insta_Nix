#!/usr/bin/env bash
set -euo pipefail
export PATH="$PATH:/run/current-system/sw/bin"

# Small logger (optional)
log() { printf '[autostart] %s\n' "$*" >&2; }

# Helper: launch only if not already running
launch_if_missing() {
  local name="$1"; shift
  if ! command -v "$name" >/dev/null 2>&1; then
    log "Missing: $name"
    return 0
  fi
  if ! pgrep -x "$name" >/dev/null; then
    log "Launching: $name"
    "$@" &
  else
    log "Already running: $name"
  fi
}

# --- Background services ---
# (Optional) tiny delay so kanshi can apply layouts before wallpaper
( sleep 0.5; launch_if_missing hyprpaper hyprpaper ) &

launch_if_missing dunst dunst
launch_if_missing nm-applet nm-applet --indicator
launch_if_missing volctl volctl --tray
launch_if_missing blueman-applet blueman-applet
launch_if_missing sxhkd sxhkd
launch_if_missing fcitx5 fcitx5 -dr

# udiskie tray
launch_if_missing udiskie udiskie --tray

# Clipboard history watcher
if command -v wl-paste >/dev/null 2>&1 && command -v cliphist >/dev/null 2>&1; then
  pgrep -fa 'wl-paste.*cliphist' >/dev/null || {
    log "Launching: cliphist watcher"
    wl-paste --watch cliphist store &
  }
else
  log "Missing: wl-paste or cliphist"
fi
